<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antworten (dynamisch)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background: #f7fafc;
      padding: 24px;
    }
    .meta {
      margin-bottom: 16px;
      color: #334155;
      font-size: 14px;
    }
    .gap-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      margin: 3px 4px 3px 0;
      border-radius: 16px;
      background: #e2e8f0;
      color: #0f172a;
      font-size: 14px;
      line-height: 1.2;
      border: 1px solid #cbd5e1;
      white-space: nowrap;
    }
    .gap-chip__user {
      color: #475569;
      font-size: 12px;
    }
    .gap-chip--richtig {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
    }
    .gap-chip--teilweise {
      background: #fef3c7;
      border-color: #f59e0b;
      color: #92400e;
    }
    .gap-chip--falsch {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }
    .gap-slot {
      position: relative;
      display: inline-block;
    }
    .gap-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      margin: 3px 4px 3px 0;
      border-radius: 18px;
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
      color: #0f172a;
      font-size: 14px;
      cursor: help;
      white-space: nowrap;
      position: relative;
    }
    .gap-summary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .gap-summary__count {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      background: #fff;
      border: 1px solid #cbd5e1;
    }
    .gap-summary__count--richtig { color: #166534; border-color: #22c55e; }
    .gap-summary__count--teilweise { color: #92400e; border-color: #f59e0b; }
    .gap-summary__count--falsch { color: #991b1b; border-color: #ef4444; }
    .gap-tooltip {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      z-index: 5;
      min-width: 260px;
      max-width: 420px;
      white-space: normal;
    }
    .gap-slot:hover .gap-tooltip,
    .gap-slot:focus-within .gap-tooltip,
    .gap-slot .gap-tooltip:hover {
      display: block;
    }
    .gap-tooltip__item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      margin: 4px 6px 0 0;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      font-size: 13px;
      color: #0f172a;
    }
    .gap-tooltip__item.gap-chip--richtig { background: #dcfce7; border-color: #22c55e; color: #166534; }
    .gap-tooltip__item.gap-chip--teilweise { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
    .gap-tooltip__item.gap-chip--falsch { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
    .gap-tooltip__user {
      color: #475569;
      font-weight: 600;
    }
    .gap-tooltip__age {
      color: #6b7280;
      font-size: 12px;
    }
    .gap-tooltip__actions {
      display: inline-flex;
      gap: 6px;
      margin-left: 8px;
    }
    .gap-action-btn {
      border: 1px solid #cbd5e1;
      background: #fff;
      color: #0f172a;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .gap-action-btn.is-active {
      border-color: #0f172a;
      background: #e2e8f0;
    }
    .gap-solution {
      display: inline;
      color: #15803d;
      font-weight: 700;
      font-size: 14px;
    }
    .gap-chip--empty {
      background: #fef9c3;
      border-color: #facc15;
      color: #854d0e;
    }
    .gap-slot {
      display: inline-block;
      min-width: 140px;
      min-height: 32px;
      vertical-align: middle;
      padding: 4px 6px;
      border-bottom: 2px dashed #cbd5e1;
    }
    header, footer {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Antworten im Originalblatt (dynamisch)</h1>
  </header>
  <div class="meta" id="meta"></div>
  <main id="sheet-content">
    <p>Blatt wird geladen...</p>
  </main>
  <footer>
    <p>&copy; 2025</p>
  </footer>

  <script src="api-config.js"></script>
  <script>
    function escapeHtml(str = '') {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function minutesAgo(dateString) {
      const d = new Date(dateString);
      if (Number.isNaN(d.getTime())) return '';
      const diffMs = Date.now() - d.getTime();
      return `${Math.max(0, Math.floor(diffMs / 60000))} min`;
    }

    function classifyLabel(value) {
      if (typeof value === 'number') {
        if (value >= 900) return 'RICHTIG';
        if (value >= 101) return 'TEILWEISE';
        return 'FALSCH';
      }
      const num = Number(value);
      if (!Number.isNaN(num)) {
        if (num >= 900) return 'RICHTIG';
        if (num >= 101) return 'TEILWEISE';
        return 'FALSCH';
      }
      const upper = (value || '').toString().toUpperCase();
      if (upper === 'RICHTIG') return 'RICHTIG';
      if (upper === 'TEILWEISE') return 'TEILWEISE';
      if (upper === 'FALSCH') return 'FALSCH';
      return null;
    }

    async function updateClassification(id, score, backendBase, reloadFn) {
      try {
        await fetch(backendBase + 'answer', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, classification: score }),
        });
        if (typeof reloadFn === 'function') reloadFn();
      } catch (err) {
        console.error('Konnte Klassifizierung nicht speichern', err);
      }
    }

    function transformGaps(container) {
      const gaps = Array.from(container.querySelectorAll('luecke-gap, luecke-gap-wide'));
      gaps.forEach((gap, idx) => {
        const key = gap.getAttribute('name') || `gap-${idx + 1}`;
        const solution = (gap.textContent || '').trim();
        const span = document.createElement('span');
        span.className = 'gap-slot';
        span.dataset.key = key;
        if (solution) span.dataset.solution = solution;
        gap.replaceWith(span);
      });
    }

    async function loadSheet() {
      const params = new URLSearchParams(window.location.search);
      const sheet =
        params.get('sheet') ||
        (window.API_CONFIG && window.API_CONFIG.defaultSheet) ||
        'index.html';
      const metaEl = document.getElementById('meta');
      const container = document.getElementById('sheet-content');
      metaEl.textContent = `Sheet: ${sheet} — lade Dokument...`;

      try {
        const resp = await fetch(sheet);
        if (!resp.ok) {
          container.innerHTML = '<p>Dokument konnte nicht geladen werden.</p>';
          metaEl.textContent = `Sheet: ${sheet} — Fehler ${resp.status}`;
          return { sheet };
        }

        const html = await resp.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const main = doc.querySelector('main') || doc.body || doc.documentElement;
        const clone = main.cloneNode(true);
        clone.querySelectorAll('script').forEach(s => s.remove());

        transformGaps(clone);

        container.innerHTML = '';
        container.appendChild(clone);
        metaEl.textContent = `Sheet: ${sheet} — geladen`;
        return { sheet };
      } catch (err) {
        console.error(err);
        container.innerHTML = '<p>Fehler beim Laden.</p>';
        metaEl.textContent = `Sheet: ${sheet} — Fehler beim Laden`;
        return { sheet };
      }
    }

    async function loadAnswersIntoSheet(currentSheet) {
      const metaEl = document.getElementById('meta');
      metaEl.textContent = `Sheet: ${currentSheet} — Lade Antworten...`;

      const backendBase =
        (window.API_CONFIG && window.API_CONFIG.backendBaseUrl) ||
        new URL('../abu-back/', window.location.href).toString();
      const endpoint = backendBase + 'answer?sheet=' + encodeURIComponent(currentSheet);

      try {
        const resp = await fetch(endpoint);
        if (!resp.ok) {
          metaEl.textContent = `Sheet: ${currentSheet} — Fehler ${resp.status}`;
          return;
        }

        const payload = await resp.json();
        const answers = (payload && payload.data && payload.data.answer) || [];

        const byKey = {};
        answers.forEach(entry => {
          if (!entry || !entry.key) return;
          if (!byKey[entry.key]) byKey[entry.key] = [];
          byKey[entry.key].push(entry);
        });

        Object.values(byKey).forEach(list => {
          list.sort((a, b) => (a.user || '').localeCompare(b.user || ''));
        });

        document.querySelectorAll('.gap-slot').forEach(slot => {
          const key = slot.dataset.key;
          const list = byKey[key] || [];
          const counts = { RICHTIG: 0, TEILWEISE: 0, FALSCH: 0, UNKLAR: 0 };
          const detailItems = [];

          list.forEach(entry => {
            const cls = classifyLabel(entry.classification);
            if (cls === 'RICHTIG' || cls === 'TEILWEISE' || cls === 'FALSCH') {
              counts[cls]++;
            } else {
              counts.UNKLAR++;
            }
            const value = escapeHtml(entry.value || '');
            const user = escapeHtml(entry.user || '–');
            const age = entry.updated_at ? minutesAgo(entry.updated_at) : '';
            const chipClass =
              cls === 'RICHTIG'
                ? 'gap-chip--richtig'
                : cls === 'TEILWEISE'
                ? 'gap-chip--teilweise'
                : cls === 'FALSCH'
                ? 'gap-chip--falsch'
                : '';
            const isActive = score => (cls === classifyLabel(score) ? 'is-active' : '');
            const idAttr = entry.id ? `data-id="${entry.id}"` : '';
            detailItems.push(
              `<span class="gap-tooltip__item ${chipClass}"><span>${value}</span><span class="gap-tooltip__user">${user}</span>${age ? `<span class="gap-tooltip__age">${age}</span>` : ''}${
                entry.id
                  ? `<span class="gap-tooltip__actions">
                      <button class="gap-action-btn ${isActive(1000)}" ${idAttr} data-score="1000" aria-label="RICHTIG setzen">R</button>
                      <button class="gap-action-btn ${isActive(500)}" ${idAttr} data-score="500" aria-label="TEILWEISE setzen">T</button>
                      <button class="gap-action-btn ${isActive(0)}" ${idAttr} data-score="0" aria-label="FALSCH setzen">F</button>
                    </span>`
                  : ''
              }</span>`
            );
          });

          const solution = slot.dataset.solution ? escapeHtml(slot.dataset.solution) : '';

          slot.innerHTML = `
            ${solution ? `<span class="gap-solution">${solution}</span>` : ''}
            <span class="gap-wrapper" tabindex="0">
              <span class="gap-summary">
                <span class="gap-summary__count gap-summary__count--richtig">${counts.RICHTIG}</span>
                <span class="gap-summary__count gap-summary__count--teilweise">${counts.TEILWEISE}</span>
                <span class="gap-summary__count gap-summary__count--falsch">${counts.FALSCH}</span>
              </span>
              <div class="gap-tooltip">
                ${detailItems.join('')}
              </div>
            </span>
          `;
        });

        metaEl.textContent = `Sheet: ${currentSheet} — Antworten geladen (${answers.length} Einträge)`;
      } catch (err) {
        console.error(err);
        metaEl.textContent = `Sheet: ${currentSheet} — Fehler beim Laden der Antworten`;
      }
    }

    (async function init() {
      const { sheet } = await loadSheet();
      await loadAnswersIntoSheet(sheet);
    })();

    document.addEventListener('click', e => {
      const btn = e.target.closest('.gap-action-btn');
      if (!btn) return;
      const id = btn.dataset.id;
      const score = Number(btn.dataset.score);
      const backendBase =
        (window.API_CONFIG && window.API_CONFIG.backendBaseUrl) ||
        new URL('../abu-back/', window.location.href).toString();
      if (!id || Number.isNaN(score)) return;
      updateClassification(id, score, backendBase, () => {
        const params = new URLSearchParams(window.location.search);
        const sheet =
          params.get('sheet') ||
          (window.API_CONFIG && window.API_CONFIG.defaultSheet) ||
          'index.html';
        loadAnswersIntoSheet(sheet);
      });
    });
  </script>
</body>
</html>
