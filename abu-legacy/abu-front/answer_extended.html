<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antworten im Originalblatt</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background: #f7fafc;
      padding: 24px;
    }
    .meta {
      margin-bottom: 16px;
      color: #334155;
      font-size: 14px;
    }
    .gap-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      margin: 3px 4px 3px 0;
      border-radius: 16px;
      background: #e2e8f0;
      color: #0f172a;
      font-size: 14px;
      line-height: 1.2;
      border: 1px solid #cbd5e1;
      white-space: nowrap;
    }
    .gap-chip__user {
      color: #475569;
      font-size: 12px;
    }
    .gap-chip--richtig {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
    }
    .gap-chip--teilweise {
      background: #fef3c7;
      border-color: #f59e0b;
      color: #92400e;
    }
    .gap-chip--falsch {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }
    .gap-slot {
      position: relative;
      display: inline-block;
    }
    .gap-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      margin: 3px 4px 3px 0;
      border-radius: 18px;
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
      color: #0f172a;
      font-size: 14px;
      cursor: help;
      white-space: nowrap;
      position: relative;
    }
    .gap-summary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .gap-summary__count {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      background: #fff;
      border: 1px solid #cbd5e1;
    }
    .gap-summary__count--richtig { color: #166534; border-color: #22c55e; }
    .gap-summary__count--teilweise { color: #92400e; border-color: #f59e0b; }
    .gap-summary__count--falsch { color: #991b1b; border-color: #ef4444; }
    .gap-tooltip {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      z-index: 5;
      min-width: 260px;
      max-width: 420px;
      white-space: normal;
    }
    .gap-slot:hover .gap-tooltip,
    .gap-slot:focus-within .gap-tooltip,
    .gap-slot .gap-tooltip:hover {
      display: block;
    }
    .gap-tooltip__item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      margin: 4px 6px 0 0;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      font-size: 13px;
      color: #0f172a;
    }
    .gap-tooltip__item.gap-chip--richtig { background: #dcfce7; border-color: #22c55e; color: #166534; }
    .gap-tooltip__item.gap-chip--teilweise { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
    .gap-tooltip__item.gap-chip--falsch { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
    .gap-tooltip__user {
      color: #475569;
      font-weight: 600;
    }
    .gap-tooltip__age {
      color: #6b7280;
      font-size: 12px;
    }
    .gap-tooltip__actions {
      display: inline-flex;
      gap: 6px;
      margin-left: 8px;
    }
    .gap-action-btn {
      border: 1px solid #cbd5e1;
      background: #fff;
      color: #0f172a;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .gap-action-btn.is-active {
      border-color: #0f172a;
      background: #e2e8f0;
    }
    .gap-solution {
      display: inline;
      color: #15803d;
      font-weight: 700;
      font-size: 14px;
    }
    .gap-chip--empty {
      background: #fef9c3;
      border-color: #facc15;
      color: #854d0e;
    }
    .gap-slot {
      display: inline-block;
      min-width: 140px;
      min-height: 32px;
      vertical-align: middle;
      padding: 4px 6px;
      border-bottom: 2px dashed #cbd5e1;
    }
    header, footer {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Antworten im Originalblatt</h1>
  </header>
  <div class="meta" id="meta"></div>
  <main>
    <section>
      <p>
        Schauen Sie den Film über die Beziehung der Schweiz zur EU. Sie finden den Erklärclip auf
        <a href="https://www.easyvote.ch" target="_blank" rel="noopener noreferrer">easyvote.ch</a>
        unter <strong>Wissen &gt; Internationale Politik &gt; Europäische Union</strong>. Füllen Sie mit Hilfe des Films die untenstehenden Lücken aus.
      </p>

      <div class="video-container" aria-label="Erklärvideo: Die EU und die Schweiz">
        <iframe
          src="https://www.youtube.com/embed/KEQaXHlqFsI"
          title="Die EU und die Schweiz - einfach und neutral erklärt!"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
        ></iframe>
      </div>

      <p>
        Die Schweiz hat viele Verträge mit internationalen Organisationen und anderen Ländern. Der wichtigste Partner der Schweiz ist
        <span class="gap-slot" data-key="luecke1" data-solution="die Europäische Union (EU)"></span>
        . Sie ist ein Staatenverbund. Das ist ähnlich wie die Schweiz bevor sie
        <span class="gap-slot" data-key="luecke2" data-solution="zum Bundesstaat"></span>
        wurde, jedoch mit einer stärkeren Zusammenarbeit zwischen den Mitgliedsländern, insbesondere einem gemeinsamen Wirtschaftsgebiet (wie in der Schweiz erstmals in der Zeit
        <span class="gap-slot" data-key="luecke3" data-solution="von Napoleon = helvetische Republik"></span>
        ).
      </p>

      <p>
        Das bedeutet einerseits, dass Bürger der EU
        <span class="gap-slot" data-key="luecke4" data-solution="frei wählen"></span>
        können, wo sie wohnen und arbeiten
        (<span class="gap-slot" data-key="luecke5" data-solution="Personenfreizügigkeit"></span>)
        und andererseits, dass es einheitliche Gesetze und keine Zölle zwischen den
        <span class="gap-slot" data-key="luecke6" data-solution="Mitgliedstaaten"></span>
        gibt.
      </p>

      <p>
        Die Schweiz hat viele Verträge mit der EU abgeschlossen, um gleichberechtigt am europäischen
        <span class="gap-slot" data-key="luecke7" data-solution="europäischen Binnenmarkt"></span>
        teilnehmen zu können. Man nennt diese Verträge auch
        <span class="gap-slot" data-key="luecke8" data-solution="bilaterale Verträge"></span>
        . Da die EU ihre Gesetze laufend anpasst und erweitert, muss auch die Schweiz regelmässig ihre Gesetze und Verträge anpassen.
      </p>

      <p>
        Um diesen Prozess zu vereinfachen, könnte man ein
        <span class="gap-slot" data-key="luecke9" data-solution="institutionelles Rahmenabkommen mit der EU"></span>
        abschliessen. Dieses kam jedoch nicht zustande, weil die Mehrheit des Parlamentes dagegen war. Ein wichtiges Argument gegen das Rahmenabkommen war
        <span class="gap-slot" data-key="luecke10" data-solution="Schutz der Schweizer Löhne und der nationalen Souveränität"></span>
        . Die Befürworter des Rahmenabkommens hingegen betonen die Vorteile
        <span class="gap-slot" data-key="luecke11" data-solution="einer stabilen Zusammenarbeit und eines gesicherten Zugangs zum EU-Binnenmarkt"></span>
        zwischen der Schweiz und der EU.
      </p>
    </section>
  </main>
  <footer>
    <p>&copy; 2025</p>
  </footer>

  <script src="api-config.js"></script>
  <script>
    function escapeHtml(str = '') {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function minutesAgo(dateString) {
      const d = new Date(dateString);
      if (Number.isNaN(d.getTime())) return '';
      const now = Date.now();
      const diffMs = now - d.getTime();
      const minutes = Math.max(0, Math.floor(diffMs / 60000));
      return `${minutes} min`;
    }

    function classifyLabel(value) {
      if (typeof value === 'number') {
        if (value >= 900) return 'RICHTIG';
        if (value >= 101) return 'TEILWEISE';
        return 'FALSCH';
      }
      const num = Number(value);
      if (!Number.isNaN(num)) {
        if (num >= 900) return 'RICHTIG';
        if (num >= 101) return 'TEILWEISE';
        return 'FALSCH';
      }
      const upper = (value || '').toString().toUpperCase();
      if (upper === 'RICHTIG') return 'RICHTIG';
      if (upper === 'TEILWEISE') return 'TEILWEISE';
      if (upper === 'FALSCH') return 'FALSCH';
      return null;
    }

    async function updateClassification(id, score, backendBase, reloadFn) {
      try {
        await fetch(backendBase + 'answer', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, classification: score }),
        });
        if (typeof reloadFn === 'function') {
          reloadFn();
        }
      } catch (err) {
        console.error('Konnte Klassifizierung nicht speichern', err);
      }
    }

    async function loadAnswersIntoSheet() {
      const params = new URLSearchParams(window.location.search);
      const sheet =
        params.get('sheet') ||
        (window.API_CONFIG && window.API_CONFIG.defaultSheet) ||
        'index.html';
      const backendBase =
        (window.API_CONFIG && window.API_CONFIG.backendBaseUrl) ||
        new URL('../abu-back/', window.location.href).toString();
      const reloadSelf = () => loadAnswersIntoSheet();

      const metaEl = document.getElementById('meta');
      metaEl.textContent = `Sheet: ${sheet} — Lade Antworten...`;

      const endpoint = backendBase + 'answer?sheet=' + encodeURIComponent(sheet);

      try {
        const resp = await fetch(endpoint);
        if (!resp.ok) {
          metaEl.textContent = `Fehler beim Laden: ${resp.status}`;
          return;
        }

        const payload = await resp.json();
        const answers = (payload && payload.data && payload.data.answer) || [];

        const byKey = {};
        answers.forEach(entry => {
          if (!entry || !entry.key) return;
          if (!byKey[entry.key]) byKey[entry.key] = [];
          byKey[entry.key].push(entry);
        });

        Object.values(byKey).forEach(list => {
          list.sort((a, b) => (a.user || '').localeCompare(b.user || ''));
        });

        document.querySelectorAll('.gap-slot').forEach(slot => {
          const key = slot.dataset.key;
          const list = byKey[key] || [];
          const counts = { RICHTIG: 0, TEILWEISE: 0, FALSCH: 0, UNKLAR: 0 };
          const detailItems = [];

          list.forEach(entry => {
            const cls = classifyLabel(entry.classification);
            if (cls === 'RICHTIG' || cls === 'TEILWEISE' || cls === 'FALSCH') {
              counts[cls]++;
            } else {
              counts.UNKLAR++;
            }
            const value = escapeHtml(entry.value || '');
            const user = escapeHtml(entry.user || '–');
            const age = entry.updated_at ? minutesAgo(entry.updated_at) : '';
            const chipClass =
              cls === 'RICHTIG'
                ? 'gap-chip--richtig'
                : cls === 'TEILWEISE'
                ? 'gap-chip--teilweise'
                : cls === 'FALSCH'
                ? 'gap-chip--falsch'
                : '';
            const isActive = score => (cls === classifyLabel(score) ? 'is-active' : '');
            const idAttr = entry.id ? `data-id="${entry.id}"` : '';
            detailItems.push(
              `<span class="gap-tooltip__item ${chipClass}"><span>${value}</span><span class="gap-tooltip__user">${user}</span>${age ? `<span class="gap-tooltip__age">${age}</span>` : ''}${
                entry.id
                  ? `<span class="gap-tooltip__actions">
                      <button class="gap-action-btn ${isActive(1000)}" ${idAttr} data-score="1000" aria-label="RICHTIG setzen">R</button>
                      <button class="gap-action-btn ${isActive(500)}" ${idAttr} data-score="500" aria-label="TEILWEISE setzen">T</button>
                      <button class="gap-action-btn ${isActive(0)}" ${idAttr} data-score="0" aria-label="FALSCH setzen">F</button>
                    </span>`
                  : ''
              }</span>`
            );
          });

          const solution = slot.dataset.solution ? escapeHtml(slot.dataset.solution) : '';

          slot.innerHTML = `
            ${solution ? `<span class="gap-solution">${solution}</span>` : ''}
            <span class="gap-wrapper" tabindex="0">
              <span class="gap-summary">
                <span class="gap-summary__count gap-summary__count--richtig">${counts.RICHTIG}</span>
                <span class="gap-summary__count gap-summary__count--teilweise">${counts.TEILWEISE}</span>
                <span class="gap-summary__count gap-summary__count--falsch">${counts.FALSCH}</span>
              </span>
              <div class="gap-tooltip">
                ${detailItems.join('')}
              </div>
            </span>
          `;
        });

        metaEl.textContent = `Sheet: ${sheet} — Antworten geladen (${answers.length} Einträge)`;
      } catch (err) {
        console.error(err);
        metaEl.textContent = 'Fehler beim Laden der Antworten.';
      }
    }

    loadAnswersIntoSheet();

    document.addEventListener('click', e => {
      const btn = e.target.closest('.gap-action-btn');
      if (!btn) return;
      const id = btn.dataset.id;
      const score = Number(btn.dataset.score);
      const backendBase =
        (window.API_CONFIG && window.API_CONFIG.backendBaseUrl) ||
        new URL('../abu-back/', window.location.href).toString();
      if (!id || Number.isNaN(score)) return;
      updateClassification(id, score, backendBase, loadAnswersIntoSheet);
    });
  </script>
</body>
</html>
