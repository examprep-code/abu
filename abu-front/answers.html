<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antworten Übersicht</title>
  <style>
    :root {
      color-scheme: light;
    }
    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #f8fafc;
      color: #0f172a;
    }
    h1 {
      margin-bottom: 8px;
    }
    p {
      margin: 4px 0 16px;
    }
    code {
      background: #e2e8f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .table-wrap {
      overflow-x: auto;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 520px;
    }
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }
    th {
      background: #f1f5f9;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-size: 12px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .status {
      margin-bottom: 12px;
      font-size: 14px;
      color: #475569;
    }
  </style>
</head>
<body>
  <h1>Antworten Übersicht</h1>
  <p>Filter via URL: <code>?sheet=&lt;name&gt;&amp;user=&lt;optional&gt;</code></p>
  <div class="status" id="status">Lade Antworten...</div>
  <div class="table-wrap">
    <table id="answerTable">
      <thead>
        <tr>
          <th>Lücke (key)</th>
          <th>User</th>
          <th>Value</th>
          <th>Sheet</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <script src="api-config.js"></script>
  <script>
    async function loadAnswers() {
      const statusEl = document.getElementById('status');
      const tbody = document.querySelector('#answerTable tbody');
      const params = new URLSearchParams(window.location.search);
      const backendBase =
        (window.API_CONFIG && window.API_CONFIG.backendBaseUrl) ||
        new URL('../abu-back/', window.location.href).toString();
      const sheet =
        params.get('sheet') ||
        (window.API_CONFIG && window.API_CONFIG.defaultSheet) ||
        'index.html';
      const user =
        params.get('user') ||
        (window.API_CONFIG && window.API_CONFIG.defaultUser) ||
        '';

      statusEl.textContent = `Lade Antworten für Sheet "${sheet}"${user ? ' und User "' + user + '"' : ''}...`;

      let endpoint = backendBase + 'answer?sheet=' + encodeURIComponent(sheet);
      if (user) {
        endpoint += '&user=' + encodeURIComponent(user);
      }

      try {
        const resp = await fetch(endpoint);
        if (!resp.ok) {
          statusEl.textContent = 'Fehler beim Laden: ' + resp.status;
          return;
        }

        const payload = await resp.json();
        const answers = (payload && payload.data && payload.data.answer) || [];

        answers.sort((a, b) => {
          const k = (a.key || '').localeCompare(b.key || '');
          if (k !== 0) return k;
          return (a.user || '').localeCompare(b.user || '');
        });

        tbody.innerHTML = '';
        if (!answers.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.textContent = 'Keine Einträge gefunden.';
          tr.appendChild(td);
          tbody.appendChild(tr);
        } else {
          answers.forEach(entry => {
            const tr = document.createElement('tr');
            tr.innerHTML =
              '<td>' + (entry.key || '') + '</td>' +
              '<td>' + (entry.user || '') + '</td>' +
              '<td>' + (entry.value || '') + '</td>' +
              '<td>' + (entry.sheet || '') + '</td>';
            tbody.appendChild(tr);
          });
        }

        statusEl.textContent = `Gefundene Einträge: ${answers.length}`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Fehler beim Laden der Antworten.';
      }
    }

    loadAnswers();
  </script>
</body>
</html>
